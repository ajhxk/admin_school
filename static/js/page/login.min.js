$(function(){
	//缓存JQ元素
	var $submitBtn = $('.login_dl_btn'),
		$inputTel = $('#username_input'),
		$inputPd = $('#psd_input'),
		$errorMsg = $('.error_msg'),
		$remberPd = $('#remberPassword'),
		$autoLogin = $('#autoLogin');

	/**
     * 禁止空格输入
     * @param e
     * @returns {Boolean}
     */
    function banInputSapce(e){
        var keynum;
        if(window.event) // IE
        {
            keynum = e.keyCode
        }
        else if(e.which) // Netscape/Firefox/Opera
        {
            keynum = e.which
        }
        if(keynum == 32){
            return false;
        }
        return true;
    } 

    /**
     * 验证规则—记录cookie
     * @returns {Boolean}
     */
    function checkAndExecute(){
     	var u = $inputTel.val().trim();
     	var	p = $inputPd.val().trim();

     	//用户名为空
     	if(u === undefined || u === ''){
     		$errorMsg.text('用户名不能为空');
            $errorMsg.css('visibility', 'visible');
     		return false;
     	};

     	// //手机正则
     	// if (!(/^1[3|4|5|7|8]\d{9}$/.test(u))) {
     	// 	u_error_msg.val('请输入正确的手机号');
     	// 	return false;
     	// };

     	//密码错误
     	if(p === undefined || p === '' || p.length < 6 || p.length > 12){
     	   $errorMsg.text('密码格式错误');
           $errorMsg.css('visibility', 'visible');
     		return false;
     	}

     	//记住密码
     	if($remberPd.hasClass('login_box_check')){
     		$.cookie('userName', u);
     		$.cookie('password', p);
     	};

     	//自动登录
     	if($autoLogin.hasClass('login_box_check')){
     		$.cookie('userName', u);
     		$.cookie('password', p);
     		$.cookie('autoLogin', '1');
     	}

     	return true;
    }

    /**
     * 记住密码
     */
    function remberPdToggle(){
     	if($remberPd.hasClass('login_box_check')){
     		$remberPd.removeClass('login_box_check');
     		$.cookie('userName', null);
     		$.cookie('password', null);
     	}else{
     		$remberPd.addClass('login_box_check');
     	}
    }

    /**
     * 自动登录
     */
    function autoLoginToggle(){
    	if($autoLogin.hasClass('login_box_check')){
    		$autoLogin.removeClass('login_box_check');
    		$.cookie('autoLogin', null);
    	}else{
    		$autoLogin.addClass('login_box_check');
    	}
    }

    /**
     * 提交表单
     * @returns {Boolean}
     */
    function _formSubmit(){
    	var userName = $inputTel.val(),
    		password = $inputPd.val();

    	if(!checkAndExecute()){
    		return false;
    	};

    	$.ajax({
    		url: '/login/submit',
    		type: 'POST',
            cache: false,
    		dataType: 'json',
    		data: {
    			'username': userName,
    			'password': password
    		},
    		success: function(data){
                if (data.type == 200) {
                    window.location.href = '/login/submit?username=' + userName + '&password=' + password
                }else if(data.type == 500){
                    $errorMsg.text('用户名或密码错误');
                    $errorMsg.css('visibility', 'visible');
                }
    		},
    		error: function(){

    		}
    	});
    }


    /**
     * 页面初始化
     */
    function pageInit(){
    	var userName = $.cookie('userName');
    	if(userName != null && userName != '' && userName != 'null'){
    		$inputTel.val(userName);
    	};

    	var password = $.cookie('password');
    	if(password != null && password != '' && password != 'null'){
    		$inputPd.val(password);
    		$remberPd.addClass('login_box_check');
    	};

    	var autoLogin = $.cookie('autoLogin');
    	if(autoLogin == '1'){
    		$autoLogin.addClass('login_box_check');
    		$.ajax({
                url: '/login/submit',
                type: 'POST',
                cache: false,
                dataType: 'json',
                data: {
                    'username': userName,
                    'password': password
                },
                success: function(data){
                    if (data.type == 200) {
                        window.location.href = '/login/submit?username=' + userName + '&password=' + password
                    }else if(data.type == 500){
                        $errorMsg.text('用户名或密码错误');
                        $errorMsg.css('visibility', 'visible');
                    }
                },
                error: function(){
    
                }
            });
    	};

        $('#username_input, #psd_input').on('focus',function(){
            $errorMsg.text('');
            $errorMsg.css('visibility', 'hidden');
        })

    	$remberPd.on('click', function(){
    		remberPdToggle();
    	});

    	$autoLogin.on('click', function(){
    		autoLoginToggle();
    	})

    	var formSubmit = WH.util.throttle(_formSubmit,1000);

    	$submitBtn.on('click', function(){
    		formSubmit();
    	});


    	//禁止用户输入空格
    	$inputPd.on('keydown', function(event){return banInputSapce(event)});
        $inputTel.on('keydown', function(event){return banInputSapce(event)});
    }

    pageInit();
})